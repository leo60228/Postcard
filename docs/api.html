<!doctype html>
<html>

    <head>
        <title>Postcard API</title>
    </head>

    <body>
        <script>
            function guidGenerator() {
                var S4 = function() {
                   return (((1+Math.random())*0x10000)|0).toString(16).substring(1);
                };
                return (S4()+S4()+"-"+S4()+"-"+S4()+"-"+S4()+"-"+S4()+S4()+S4());
            }
            
            async function userExec(func) {
                return new Promise((resolve, reject) => {
                    const tag = guidGenerator();
                    
                    function handler(event) {
                        if (event.data != tag) return;
                        window.removeEventListener('message', handler);
                        console.log(`Executed code with tag ${tag}`);
                        resolve();
                    }
                    
                    window.addEventListener('message', handler);
                    
                    console.log(`Executing code with tag ${tag}`);
                    window.parent.postMessage(`(${func.toString()})(); window.apiframe.postMessage('${tag}', '*')`, '*');
                });
            }
            
            async function userValue(func) {
                return new Promise((resolve, reject) => {
                    const tag = guidGenerator();
                    
                    function handler(event) {
                        if (event.data.tag != tag) return;
                        window.removeEventListener('message', handler);
                        console.log(`Fetched ${event.data.value.length < 50 ? event.data.value : 'a large value'} with tag ${tag}`);
                        resolve(event.data.value);
                    }
                    
                    window.addEventListener('message', handler);
                    
                    console.log(`Fetching value with tag ${tag}`);
                    window.parent.postMessage(`window.apiframe.postMessage({value: (${func.toString()})(), tag: '${tag}'}, '*')`, '*');
                });
            }
            
            async function addStyles() {
                console.log('adding styles to user page');
                return await userExec(() => {
                    var style = document.createElement('style');
                    style.type = 'text/css';
                    style.innerHTML = `
                    body, html, iframe {
                        margin: 0;
                        border: 0;
                        width: 100%;
                        height: 100%;
                    }
                    `;
                    document.getElementsByTagName('head')[0].appendChild(style);
                });
            }
            
            async function main() {
                await userExec(() => window.apiframe = document.querySelector('iframe').contentWindow);
                await addStyles();
                const base64 = await userValue(() => /* global b */ b);
                console.log(atob(base64));
            }
            
            window.parent.postMessage('window.apiframe = document.querySelector("iframe").contentWindow', '*');
            setTimeout(main, 50);
        </script>
    </body>

</html>
